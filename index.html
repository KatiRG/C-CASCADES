<!DOCTYPE html>
<meta charset="utf-8">

<script src="lib/d3.v3.min.js"></script>
<script src="lib/jquery-1.10.2.min.js"></script>
<!--bootstrap 3.0.2 -->
<link href="lib/bootstrap.css" rel="stylesheet">
<script src="lib/bootstrap.min.js"></script>
<link href="style.css" rel="stylesheet" type="text/css">

<title>CO2 Fluxes</title>

<body>

	<div class="container">
    
    <div class="row"> <!-- header row -->
      	<div class="col-lg-7 headings" style="text-align: center; left:207px;">
        	CO<sub>2</sub> fluxes across countries and regions from freshwater sources
      	</div>

      	<div id="infotext">
      		CO<sub>2</sub> flux estimates over the period 2003&ndash;2012 from the LOAC budget showing contributions (mean [min, max] in Tg CO<sub>2</sub> yr<sup>-1</sup>) from 3 freshwater source categories (Rivers, Lakes, and Estuaries) in terms of 3 latitude bands and 6 continental regions.
      	</div>
    </div> <!-- ./header row -->

    <div class="row"> <!-- info row 1 -->
    	<div id="subtitle">Total freshwater CO<sub>2</sub> fluxes: 1292.0 Tg CO<sub>2</sub> yr<sup>-1</sup></div>
    	<div id="chart">
	    </div>
	</div> <!-- ./info row 1 -->

	<script src="sankey.js"></script>
    <script>

    	//Read data      
        //var jsonFile = "data/test_3levels_co2.json";
        var jsonFile = "data/test_mean_3levels.json";

        //Global stats
        //Global stats for sources
        //statsTab2_emis03-12_TDpost_BU_5cat_GLOBAL_v3_4May2016.txt
        var TD_sourceStats = [
          {sourceName:"Fossil", mean: 105, min:77, max:133},
          {sourceName:"Agriwast", mean: 188, min:115, max:243},
          {sourceName:"BioBurBiof", mean: 34, min:15, max:53},
          {sourceName:"Wetlands", mean: 167, min:127, max:202},
          {sourceName:"OtherNat", mean: 64, min:21, max:132}
        ];

        //Regional stats. TD from Table 4 in manuscript.
        var TD_regionStats = [
          {sourceName:"Cent_NAme", mean: 11, min: 5, max: 15},
          {sourceName:"Trop_SAme", mean: 84, min: 65, max: 101},
          {sourceName:"Temp_SAme", mean: 17, min: 12, max: 27},
          {sourceName:"NAfr", mean: 42, min: 36, max: 55},
          {sourceName:"SAfr", mean: 44, min: 37, max: 53},
          {sourceName:"SE_Asia", mean: 73, min: 55, max: 84},
          {sourceName:"India", mean: 39, min: 37, max: 46},
          {sourceName:"Oceania", mean: 11, min: 7, max: 19},
          {sourceName:"contUSA", mean: 41, min: 34, max: 49},
          {sourceName:"Europe", mean: 28, min: 21, max: 34},
          {sourceName:"Temp_Eurasia_Japan", mean: 46, min: 38, max: 54},
          {sourceName:"China", mean: 58, min: 51, max: 72},
          {sourceName:"Bor_NAme", mean: 20, min: 13, max: 27},
          {sourceName:"Russia", mean: 38, min: 31, max: 44}
        ];

        makeSankey("#chart", jsonFile, TD_sourceStats, TD_regionStats);

        function makeSankey(chart_div, jsonFile, sourceStats, regionStats) {          
	         var margin = {
	            top: 0,
	            right: 0,
	            bottom: 0,
	            left: 60
	        };

	        var width = 1000 - margin.left - margin.right,
	            height = 700 - margin.top - margin.bottom;

	        var formatNumber = d3.format(".0f"), //d3.format(".2f"),
	            format = function(d) {
	              return formatNumber(d);
	            },
	        color = d3.scale.category20();

	        //append the svg canvas to the page
	        var svg = d3.select(chart_div).append("svg")
	            .attr("width", width + margin.left + margin.right)
	            .attr("height", height + margin.top + margin.bottom)
	            //.style("border", "1px solid black")
	            .append("g")
	            .attr("transform",
	              "translate(" + margin.left + "," + margin.top + ")"
	            );

	        //set the sankey diagram properties
	        var sankey = d3.sankey()
	            .nodeWidth(35)
	            .nodePadding(50)
	            .size([width, height]);

	        var path = sankey.link();

	        var col_xcoord = []; //x-coords of Sankey cols

	        var units = "Tg CO<sub>2</sub> yr <sup>-1</sup>";

	        //https://www.colorcodehex.com/eff3ff/
          	var colour_dict = {
	            //regions
	            "Africa": "#F9D423",
	            "Asia": "#7FA0FF",
	            "Europe": "#FCAA70",
	            "NorthAmer": "#FCAA70",
	            "SouthAmer": "#FCAA70",
	            "Oceania": "#AAA993",
	            //sources
	            "lakes": "#87f4ff",
	            "rivers": "#ee3b3b",
	            "estuaries": "#d3d3d3",
	            //latitude bands
	            "midLat": "#e9e9e9",
	            "highLat": "#e9e9e9",
	            "tropics": "#aef8ff"
          	};

	        //load the data        
	        d3.json(jsonFile, function(error, graph) {
	            make(graph);
	        });


	        function make(graph) {
	        	var nodeMap = {};
	            graph.nodes.forEach(function(x) {
	              nodeMap[x.name] = x;
	            });
	            graph.links = graph.links.map(function(x) {
	              return {
	                source: nodeMap[x.source],
	                target: nodeMap[x.target],
	                value: x.value
	              };
	            });

	            graph.nodes.sort(function(a, b) {
	              return d3.descending(a.value, b.value);
	            });

	            sankey
	              .nodes(graph.nodes)
	              .links(graph.links)
	              .layout(32);


	            //add the links
	            // var link = svg.append("g").selectAll(".link")
		           //    .data(graph.links)
		           //    .enter().append("path")
		           //    .attr("class", function (d) {		               
		           //        if (categories.indexOf(d.target.name) != -1 ){
		           //          if (subCategories.indexOf(d.source.name) != -1) {
		           //            return "link link-subsources belongsTo-" + d.target.name;
		           //          }
		           //        } else return "link";	               
		           //    })
		           //    .attr("d", path)
		           //    .attr("id", function (d, i) {
		           //      d.id = i;
		           //      return "link-" + i;
		           //    })
		           //    .style("stroke-width", function(d) {
		           //      return Math.max(1, d.dy);
		           //    })
		           //    .style("stroke", function (d) {
		           //      return colour_dict[d.target.name];
		           //    })
		           //    .style("opacity", function (d) {
		           //      return 1;
		           //    })
		           //    .style("cursor", function (d) {
		           //     	return "crosshair";
		           //    })
		           //    .sort(function(a, b) {
		           //      return b.dy - a.dy;
		           //    });
		           //  // .call(function () {
		           //  //   DO NOT PUT CALL IN link, PUT IN node (see below)
		           //  //   manualLayout();
		           //  // });
	            // //d3.selectAll(".link-subsources").style("display", "none");

	            var link = svg.append("g").selectAll(".link")
				      .data(graph.links)
				    .enter().append("path")
				      .attr("class", "link")
				      .attr("d", path)
				      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
				      .sort(function(a, b) { return b.dy - a.dy; })
				      .style("stroke", function (d) {
		                return colour_dict[d.target.name];
		              });

	           

	        } //end make()

	    } //end makeSankey()

	    //=================================================
        // FUNCTIONS
        //=================================================
        // http://stackoverflow.com/questions/1960473/unique-values-in-an-array
        function uniques(arr) {
            var a = [];
            for (var i = 0, l = arr.length; i < l; i++)
              if (a.indexOf(arr[i]) === -1 && arr[i] !== '')
                a.push(arr[i]);
            return a;
        }



    </script>




	</div><!-- /.container -->

</body>

</html>