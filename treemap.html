<!DOCTYPE html>
<meta charset="utf-8">

<script src="lib/d3.v3.min.js"></script>
<script src="lib/jquery-1.10.2.min.js"></script>
<!--bootstrap 3.0.2 -->
<link href="lib/bootstrap.css" rel="stylesheet">
<script src="lib/bootstrap.min.js"></script>
<link href="style.css" rel="stylesheet" type="text/css">

<title>CO2 Fluxes</title>

<body>

	<div class="container">
    
    <div class="row"> <!-- header row -->
      	<div class="col-lg-12 headings">
      		CO<sub>2</sub> fluxes across countries and regions from freshwater sources
      	</div>
    </div> <!-- ./header row -->
    <div class="row"> <!-- info row -->
      	<div class="col-lg-12" id="infotext">
      		CO<sub>2</sub> flux estimates over the period 2003&ndash;2012 from the LOAC budget showing contributions (mean [min, max] in Tg CO<sub>2</sub> yr<sup>-1</sup>) from 3 freshwater source categories (Rivers, Lakes, and Estuaries) in terms of 3 latitude bands and 6 continental regions.
      	</div>
    </div> <!-- ./info row -->

    <div class="row"> <!-- row for info -->
    	<div class="col-lg-12" id="subtitle">Total freshwater CO<sub>2</sub> fluxes: 1292.0 Tg CO<sub>2</sub> yr<sup>-1</sup></div>
	</div> <!-- ./row for info -->

	<div class="row"> <!-- row for charts -->    	
    	<div class="col-lg-4" id="chart1"></div>
    	<div class="col-lg-4" id="chart2">sankey2</div>
    	<div class="col-lg-4">
    		<div class="row"> 
    			<div id="treemap1" style="padding-top:6px;"></div> <!--S Amer-->
    		</div>
    		<div class="row"> 
    			<div id="treemap2" style="padding-top:88.3px;"></div> <!--Africa-->
    		</div>
    		<div class="row"> 
    			<div id="treemap3" style="padding-top:105.5px;"></div> <!--Asia-->
    		</div>
    		<div class="row"> 
    			<div id="treemap4"></div> <!--N Amer-->
    		</div>
    		<div class="row"> 
    			<div id="treemap5"></div> <!--Oceania-->
    		</div>
    		<div class="row"> 
    			<div id="treemap6" style="padding-top:49px;"></div> <!--Europe-->
    		</div>
    	</div>
	</div> <!-- ./row for charts -->

	<!-- class="col-lg-2" -->

	<script src="sankey.js"></script>
    <script>

    	//Data files
        var jsonFile1 = "data/LOAC_budget_TgCyr181113_sankey1.json";
        var jsonFile2 = "data/LOAC_budget_TgCyr181113_sankey2.json";

        //Dictionaries
      	var colour_dict = {
            //source
            "Lakes": "#607890",
            "Rivers": "#A9C1D9",
            "Estuaries": "#ABBE71", //AED17E
            //target Sankey1
             "Mid lat": "#CC982A",
            "High lat": "#928941",
            "Tropics": "#FFDC68",
            "Europe": "#FAB491",
            "S America": "#0F7409",
            "Oceania": "#00CC99",
            "Africa": "#EBCD0C",
            "N America": "#B5B0B9",
            "Asia": "#C02942"
      	};

      	var name_dict = {
        	//latitude bands
        	"Tropics": "Tropics (> 50 degrees)",
        	"High lat": "High latitudes (< -50 degrees)",
        	"Mid lat": "Mid latitudes (30â€“50 degrees)"
    	}

        var countryColour_dict = {
        	//S America
        	"Brazil": "#15a40d",
        	"Peru": "#7FAF1B",
        	"Argentina": "#C3FF68",
        	//Africa
        	"DRC": "#fff44f",  //"#ffff4d", //"#EDAC03", //#E4F658, #FCE00F
        	//Asia
        	"China": "#ED5E6D",
        	"India": "#9D6766",
        	"Iran": "#9F8088", //"#C8C8A9",
        	"Russia": "#E78084",
        	//N America
        	"Canada": "#b9aabd",
        	"US": "#cecbd1", //"#ECE5CE",
        	//Oceania
        	"Australia": "#60ffad", //"#79ffba", //"#DEFFEE",
        	//Europe
        	"Belgium": "#8f7e94", //"#F7E9CC",
        	"Sweden": "#F1D4AF"
        }

        //Call each component
        makeSankey("#chart1", jsonFile1, 1);
        makeSankey("#chart2", jsonFile2, 2);

        makeTreemap("#treemap1", "data/treemap_samerica.json", 134.28);
        makeTreemap("#treemap2", "data/treemap_africa.json", 34.7); //pad top 87.3
        makeTreemap("#treemap3", "data/treemap_asia_withRussia.json", 134.6); //134.6 //48.37 //pad 190.7    // 231);
        makeTreemap("#treemap4", "data/treemap_namer.json", 167.316);
        makeTreemap("#treemap5", "data/treemap_oceania.json", 15);
        makeTreemap("#treemap6", "data/treemap_europe.json", 20);  //61

        function makeTreemap(chart_id, jsonFile, h) {

        	//tooltip div
            var div = d3.select("body").append("div")
              .attr("class", "tooltip")
              .style("opacity", 0);
            var units = "Tg CO<sub>2</sub> yr <sup>-1</sup>";
	        var yshift_tooltip = 90; //amount to raise tooltip in y-dirn

        	var w = 390,//130,
		    //h = 100,
		    x = d3.scale.linear().range([0, w]),
		    y = d3.scale.linear().range([0, h]),
		    color = d3.scale.category20c(),
		    root,
		    node;

			var treemap = d3.layout.treemap()
			    .round(false)
			    .size([w, h])
			    .sticky(true)
			    .value(function(d) { return d.total; });

			var svg = d3.select(chart_id).append("div")
			    .attr("class", "chart")
			    .style("width", w + "px")
			    .style("height", h + "px")
			  .append("svg:svg")
			    .attr("width", w)
			    .attr("height", h)
			  .append("svg:g")
			    .attr("transform", "translate(.5,.5)");

			//d3.json("kinoko_takenoko.json", function(data) {
			d3.json(jsonFile, function(data) {
				node = root = data;
				console.log(data);
				var nodes = treemap.nodes(root)
				    .filter(function(d) {return !d.children; });

				var cell = svg.selectAll("g")
				    .data(nodes)
				    .enter().append("svg:g")
				      .attr("class", "cell")
				      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

				cell.append("svg:rect")
				    .attr("width", function(d) { return d.dx - 1; })
				    .attr("height", function(d) { return d.dy - 1; })
				    .style("fill", function(d) {
				     	console.log("fill d: ", d)
				      	console.log("fill d parent: ", d.parent.name)
				      	// return color(d.parent.name);
				      	return countryColour_dict[d.parent.name];
				    })
				    .style("cursor", function (d) {
	                	return "crosshair";
	              	});

				 cell.append("svg:text")
				    .attr("x", function(d) { return d.dx / 2; })
				    .attr("y", function(d) { return d.dy / 2; })
				    .attr("dy", ".35em")
				    .attr("text-anchor", "middle")
				    .text(function(d) { return d.name; })
				    .style("opacity", function(d) { d.w = this.getComputedTextLength(); return d.dx > d.w ? 1 : 0; })
				    .style("cursor", function (d) {
	                	return "crosshair";
	              	});

			    cell.on("mouseover", function(d) {
					console.log("MOUSEOVER d: ", d)
					console.log("d.parent.children: ", d.parent.children)
					console.log("Rivers LOAC: ", d.parent.children.find(x => x.LOAC === "Rivers"))
					console.log("Rivers tot LOAC: ", d.parent.children.find(x => x.LOAC === "Rivers").total)
					
					var title = d.parent.name,
					 	val_rivers = d.parent.children.find(x => x.LOAC === "Rivers").total,
					 	val_lakes = d.parent.children.find(x => x.LOAC === "Lakes").total,
					 	val_est = d.parent.children.find(x => x.LOAC === "Estuaries").total;

					div.transition()
					    .style("opacity", .9);
				  	div.html(
				        "<b>" + title + "</b>"+ "<br><br>" +
				        "<table>" +
				          "<tr>" + 
				          "<td> Rivers (R): </td>" +
				            "<td><b>" + val_rivers  + "</td>" +
				            "<td>" + " " + units + "</td>" +
				          "</tr>" +

				          "<tr>" + 
				          "<td> Lakes (L): </td>" +
				            "<td><b>" + val_lakes  + "</td>" +
				            "<td>" + " " + units + "</td>" +
				          "</tr>" +

				          "<tr>" + 
				          "<td> Estuaries (E): </td>" +
				            "<td><b>" + val_est  + "</td>" +
				            "<td>" + " " + units + "</td>" +
				          "</tr>" +

				        "</table>"
				    )
				    .style("left", (d3.event.pageX) + "px")
				    .style("top", (d3.event.pageY - yshift_tooltip) + "px");



				   })
				  .on("mouseout", function(d) {
				  	//Remove active and inactive classes added on mouseover
				   	div.transition()
      				   .style("opacity", 0);
				  });
				  
			});

			// function size(d) {
			//   return d.size;
			// }

			// function total(d) {
			//   return d.total;
			// }

			// function building(d) {
			//   return d.building;
			// }

			// function ground(d) {
			//   return d.ground;
			// }

			// function cash(d) {
			//   return d.cash;
			// }

			// function count(d) {
			//   return 1;
			// }

        } //.makeTreemap

        function makeSankey(chart_div, jsonFile, chartNum) {
	         var margin = {
	            top: 0,
	            right: 0,
	            bottom: 0,
	            left: 0
	        };

	        var width = 360 - margin.left - margin.right,
	            height = 1500 - margin.top - margin.bottom;

	        var formatNumber = d3.format(".2f"), //d3.format(".2f"),
	            format = function(d) {
	              return formatNumber(d);
	            },
	        color = d3.scale.category20();

	        //append the svg canvas to the page
	        var svg = d3.select(chart_div).append("svg")
	            .attr("width", width + margin.left + margin.right)
	            .attr("height", height + margin.top + margin.bottom)
	            //.style("border", "1px solid black")
	            .append("g")
	            .attr("transform",
	              "translate(" + margin.left + "," + margin.top + ")"
	            );

	        //set the sankey diagram properties
	        var sankey = d3.sankey()
	            .nodeWidth(30)
	            .nodePadding(10)
	            .size([width, height]);

	        var path = sankey.link();

	        var col_xcoord = []; //x-coords of Sankey cols

	        var units = "Tg CO<sub>2</sub> yr <sup>-1</sup>";
	        var yshift_tooltip = 90; //amount to raise tooltip in y-dirn

	        //load the data        
	        d3.json(jsonFile, function(error, graph) {
	            make(graph);
	        });


	        function make(graph) {
	        	var nodeMap = {};
	            graph.nodes.forEach(function(x) {
	              nodeMap[x.name] = x;
	            });
	            graph.links = graph.links.map(function(x) {
	              return {
	                source: nodeMap[x.source],
	                target: nodeMap[x.target],
	                value: x.value
	              };
	            });

	            graph.nodes.sort(function(a, b) {
	              return d3.descending(a.value, b.value);
	            });

	            sankey
	              .nodes(graph.nodes)
	              .links(graph.links)
	              .layout(32);

	            //tooltip div
	            var div = d3.select("body").append("div")
	              .attr("class", "tooltip")
	              .style("opacity", 0);


	            //add the links
	            // var link = svg.append("g").selectAll(".link")
		           //    .data(graph.links)
		           //    .enter().append("path")
		           //    .attr("class", function (d) {		               
		           //        if (categories.indexOf(d.target.name) != -1 ){
		           //          if (subCategories.indexOf(d.source.name) != -1) {
		           //            return "link link-subsources belongsTo-" + d.target.name;
		           //          }
		           //        } else return "link";	               
		           //    })
		           //    .attr("d", path)
		           //    .attr("id", function (d, i) {
		           //      d.id = i;
		           //      return "link-" + i;
		           //    })
		           //    .style("stroke-width", function(d) {
		           //      return Math.max(1, d.dy);
		           //    })
		           //    .style("stroke", function (d) {
		           //      return colour_dict[d.target.name];
		           //    })
		           //    .style("opacity", function (d) {
		           //      return 1;
		           //    })
		           //    .style("cursor", function (d) {
		           //     	return "crosshair";
		           //    })
		           //    .sort(function(a, b) {
		           //      return b.dy - a.dy;
		           //    });
		           //  // .call(function () {
		           //  //   DO NOT PUT CALL IN link, PUT IN node (see below)
		           //  //   manualLayout();
		           //  // });
	            // //d3.selectAll(".link-subsources").style("display", "none");

	            var link = svg.append("g").selectAll(".link")
				      .data(graph.links)
				    .enter().append("path")
				      //.attr("class", "link")
				      .attr("class", function (d, i) {
		              	var fromName = "from" + d.source.name.replace(/\s+/g, '') + chartNum,
		              		toName = "to" + d.target.name.replace(/\s+/g, '') + chartNum;
		              	return "link" + " " + fromName + " " + toName;
		              })
				      .attr("d", path)
				      .attr("id", function (d, i) {
		                d.id = i;
		                return "link-" + i;
		              })
				      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
				      .sort(function(a, b) { return b.dy - a.dy; })
				      .style("stroke", function (d) {
		                return colour_dict[d.source.name];
		              });

		        //add link tooltip
	            link.on("mouseover", function(d) {
	                // var minValue = getStat(minStat, d),
	                //   maxValue = getStat(maxStat, d);

	                //Reduce opacity of all but link that is moused over	                
	                d3.selectAll(".link:not(#" + this.id + ")").style("opacity", 0.5);

                  	//Tooltip
                  	var sourceName = (d.source.name === "Tropics" || d.source.name === "Mid lat" || d.source.name === "High lat") ? 
                  					name_dict[d.source.name] : d.source.name;
                 	div.transition()
                    .style("opacity", .9);
                  	div.html(
	                    "<b>" + sourceName + "</b>"+ "<br><br>" +
	                    "<table>" +
	                      "<tr>" + 
	                      "<td>" + d.target.name + " flux: </td>" +
	                        "<td><b>" + format(d.value)  + "</td>" +
	                        "<td>" + " " + units + "</td>" +
	                      "</tr>" +
	                    "</table>"
                    )
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - yshift_tooltip) + "px");
	              })
	              .on("mouseout", function(d) {   

	                //Restore opacity
	                d3.selectAll(".link:not(#" + this.id + ")").style("opacity", 1);

	                div.transition()
	                  .style("opacity", 0);
	              });

		        //add in the nodes
	            var node = svg.append("g").selectAll(".node")
	              .data(graph.nodes)
	              .enter().append("g")
	              .attr("class", function(d) {
	                return "node regions";
	              })
	              .attr("transform", function(d) {
	                //col_xcoord.push(d.x); //x-coord of each Sankey col
	                return "translate(" + d.x + "," + d.y + ")";
	              })
	              .style("cursor", function (d) {
	                 return "crosshair";
	              })
	              .call(d3.behavior.drag() //moves nodes with mouse drag
		              .origin(function(d) {
		                return d;
		              })
		              .on("drag", dragmove)
		           );
	              // .on("click", highlight_node_links)
	              // .call(function() {
	              //   manualLayout();
	              // })

				//apend rects to the nodes
            	node.append("rect")
	              .attr("height", function(d) {
	                return d.dy;
	              })
	              .attr("width", sankey.nodeWidth())
	              .style("fill", function(d, idx) {
	                return colour_dict[d.name];
	              })
	              .style("stroke-width", "2px")
	              .style("stroke", "#555");

	            //apend text to nodes
	            node.append("text")
	              .attr("x", -6)
	              .attr("y", function(d) {
	                return d.dy / 2;
	              })
	              .attr("dy", ".35em")
	              .attr("text-anchor", "end")
	              .attr("transform", null)
	              .text(function(d) {
	              	if (d.name === "Tropics" || d.name === "Mid lat" || d.name === "High lat") return name_dict[d.name];
	                else return d.name;
	              })
	              .filter(function(d) {
	                return d.x < width / 2;
	              })
	              .attr("x", 6 + sankey.nodeWidth())
	              .attr("text-anchor", "start");

	              //add node tooltip
	              node.on("mouseover", function(d) {
	              	console.log("d: ", d)
	              	console.log("d.name: ", d.name)
	              	console.log("d.value: ", d.value)

	              	//Make all links inactive
	                d3.selectAll(".link").classed("inactive", true);

	                //Remove inactive class to selected links and make them active
	                if (d.sourceLinks.length > 0) { //rect acts as a source to next rect
	                	var fromLink = d3.selectAll(".from" + d.name.replace(/\s+/g, '') + chartNum);
	                	fromLink.classed("inactive", !fromLink.classed("inactive"));

	                	fromLink.classed("active", true);
	                }

	                if (d.targetLinks.length > 0) { //rect acts as a target from previous rect
	                	var toLink = d3.selectAll(".to" + d.name.replace(/\s+/g, '') + chartNum);	                	
	                	toLink.classed("inactive", !toLink.classed("inactive"));

	                	toLink.classed("active", true);
	                }

	              	var sourceName = (d.name === "Tropics" || d.name === "Mid lat" || d.name === "High lat") ? 
                  					name_dict[d.name] : d.name;
	              	div.transition()
                    .style("opacity", .9);
                  	div.html(
	                    "<b>" + sourceName + "</b>"+ "<br><br>" +
	                    "<table>" +
	                      "<tr>" + 
	                      "<td> Total flux: </td>" +
	                        "<td><b>" + format(d.value)  + "</td>" +
	                        "<td>" + " " + units + "</td>" +
	                      "</tr>" +
	                    "</table>"
                    )
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - yshift_tooltip) + "px");

	              })
				  .on("mouseout", function(d) {
				  	//Remove active and inactive classes added on mouseover
	                d3.selectAll(".inactive").classed("inactive", false);
	                d3.selectAll(".active").classed("active", false);

	                div.transition()
	                  .style("opacity", 0);
	              });

	            // the function for moving the nodes
		        function dragmove(d) {
		          d3.select(this).attr("transform",
		            "translate(" + (
		              d.x = d.x
		            ) + "," + (
		              d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))
		            ) + ")");

		          //move the attached links
		          sankey.relayout();
		          link.attr("d", path);
		        }

	        } //end make()	      

	    } //end makeSankey()

	    //=================================================
        // FUNCTIONS
        //=================================================
        // http://stackoverflow.com/questions/1960473/unique-values-in-an-array
        function uniques(arr) {
            var a = [];
            for (var i = 0, l = arr.length; i < l; i++)
              if (a.indexOf(arr[i]) === -1 && arr[i] !== '')
                a.push(arr[i]);
            return a;
        }



    </script>




	</div><!-- /.container -->

</body>

</html>